input {
  beats {
    type => "beats"
    port => 5044
  }

  syslog {
    port => 514
    type => "syslog"
  }
}

filter {
  if [type] == "beats" {
    grok {
      match => {
        "message" => '%{IPORHOST:host_name} - - \[%{HTTPDATE:access_time}\] "%{WORD:http_method} %{DATA:url} HTTP/%{NUMBER:http_version}" %{NUMBER:response_code} %{NUMBER:body_sent_byte} "-" "%{DATA:referrer}" "-"'
      }
      remove_field => ["message"]
    }
if [kubernetes][node][uid] {
      mutate {
        replace => { "[kubernetes][node][uid]" => "********" }
      }
    }
    mutate {
     remove_field => [
       "[kubernetes][node][hostname]",
       "[host][os][version]",
       "[host][os][platform]",
       "[host][os][name]",
       "[host][ip]",
       "[host][mac]",
       "[host][os][codename]",
       "[host][os][family]",
       "[host][os][kernel]",
       "[host][os][platform]",
       "[host][os][type]",
       "[host][os][version]",
       "[host][architecture]",
       "[container][id]",
       "[agent][version]",
       "[agent][id]",
       "[agent][hostname]",
       "[agent][ephemeral_id]",
       "[agent][type]",
       "[agent][name]",
       "[kubernetes][labels][pod-template-generation]",
       "[kubernetes][namespace_uid]",
       "[kubernetes][pod][uid]",
       "[log][file][path]",
       "[log][offset]",
       "[kubernetes][node][labels][kubernetes_io/os]",
       "[kubernetes][node][labels][kubernetes_io/hostname]",
       "[kubernetes][node][labels][kubernetes_io/arch]",
       "[kubernetes][node][labels][beta_kubernetes_io/os]",
       "[kubernetes][node][labels][beta_kubernetes_io/arch]",
       "[kubernetes][labels][controller-revision-hash]",
       "[host][hostname]"
     ]
    }
  }
  else if [type] == "syslog" {
    grok {
      match => {
        "message" => '%{SYSLOGTIMESTAMP:syslog_timestamp} %{SYSLOGHOST:syslog_host} %{DATA:program}(\[%{POSINT:pid}\])?: %{GREEDYDATA:syslog_message}'
      }
      remove_field => ["message"]
    }

    # Add host-based index prefix for syslog
    mutate {
      add_field => { "[@metadata][index_prefix]" => "syslog-%{[host]}" }
    }
  }
}

output {
  if [type] == "beats" {
    elasticsearch {
      hosts => ["http://192.168.4.198:9200"]
      ssl_certificate_verification => false
      user => "elastic"
      password => "asus1650"
      index => "filebeat-docker-%{+YYYY.MM.dd}"
    }
  } else if [type] == "syslog" {
    elasticsearch {
      hosts => ["http://192.168.4.198:9200"]
      ssl_certificate_verification => false
      user => "elastic"
      password => "asus1650"
      index => "%{[@metadata][index_prefix]}-%{+YYYY.MM.dd}"
    }
  }
}
